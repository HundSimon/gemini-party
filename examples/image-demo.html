<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini 图像生成与编辑演示</title>
    <style>
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .panel {
            flex: 1;
            min-width: 300px;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        h2 {
            margin-top: 0;
            color: #444;
        }
        textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: vertical;
            font-family: inherit;
            margin-bottom: 10px;
        }
        button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        button:hover {
            background: #3367d6;
        }
        button:disabled {
            background: #aaa;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        .image-container {
            max-width: 100%;
            overflow: hidden;
            margin-top: 10px;
        }
        .image-container img {
            max-width: 100%;
            height: auto;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .status {
            color: #666;
            font-style: italic;
            margin: 10px 0;
        }
        .error {
            color: #d32f2f;
            background: #ffebee;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .dropzone {
            border: 2px dashed #ccc;
            border-radius: 5px;
            padding: 25px;
            text-align: center;
            margin: 10px 0;
            cursor: pointer;
            transition: background 0.3s;
        }
        .dropzone:hover {
            background: #f9f9f9;
        }
        .dropzone.active {
            border-color: #4285f4;
            background: #e8f0fe;
        }
        #apiKeyInput {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .accordion {
            background: #f9f9f9;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        .accordion-content {
            display: none;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
            margin-bottom: 15px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow: auto;
            background: #fff;
        }
    </style>
</head>
<body>
    <h1>Gemini 图像生成与编辑演示</h1>
    
    <div class="panel">
        <h2>API配置</h2>
        <div>
            <label for="apiUrl">API地址：</label>
            <input type="text" id="apiUrl" value="http://localhost:3000" style="width: 80%; padding: 5px;">
        </div>
        <div>
            <label for="apiKeyInput">API密钥：</label>
            <input type="text" id="apiKeyInput" placeholder="在此输入你的Gemini API密钥">
        </div>
    </div>

    <div class="container">
        <div class="panel">
            <h2>图像生成</h2>
            <textarea id="generatePrompt" placeholder="输入描述，例如：'画一只宇航员猫咪漂浮在太空中'"></textarea>
            <button id="generateBtn">生成图像</button>
            <div id="generateStatus" class="status"></div>
            <div id="generateError" class="error" style="display: none;"></div>
            <div class="result">
                <div id="generateTextResult"></div>
                <div class="image-container">
                    <img id="generatedImage" style="display: none;">
                </div>
            </div>
        </div>

        <div class="panel">
            <h2>图像编辑</h2>
            <div class="dropzone" id="dropzone">
                拖放图片到这里或点击上传
                <input type="file" id="fileInput" style="display: none;" accept="image/*">
            </div>
            <div class="image-container">
                <img id="uploadedImage" style="display: none;">
            </div>
            <textarea id="editPrompt" placeholder="输入编辑指令，例如：'在这张图片旁边添加一只羊驼'"></textarea>
            <button id="editBtn" disabled>编辑图像</button>
            <div id="editStatus" class="status"></div>
            <div id="editError" class="error" style="display: none;"></div>
            <div class="result">
                <div id="editTextResult"></div>
                <div class="image-container">
                    <img id="editedImage" style="display: none;">
                </div>
            </div>
        </div>
    </div>

    <div class="panel">
        <div class="accordion">查看完整API响应 (点击展开)</div>
        <div class="accordion-content">
            <pre id="fullResponse"></pre>
        </div>
    </div>

    <script>
        // 保存上传的图片数据
        let uploadedImageData = null;
        
        // 获取DOM元素
        const apiUrlInput = document.getElementById('apiUrl');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const generatePrompt = document.getElementById('generatePrompt');
        const generateBtn = document.getElementById('generateBtn');
        const generateStatus = document.getElementById('generateStatus');
        const generateError = document.getElementById('generateError');
        const generatedImage = document.getElementById('generatedImage');
        const generateTextResult = document.getElementById('generateTextResult');
        
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');
        const uploadedImage = document.getElementById('uploadedImage');
        const editPrompt = document.getElementById('editPrompt');
        const editBtn = document.getElementById('editBtn');
        const editStatus = document.getElementById('editStatus');
        const editError = document.getElementById('editError');
        const editedImage = document.getElementById('editedImage');
        const editTextResult = document.getElementById('editTextResult');
        
        const fullResponse = document.getElementById('fullResponse');
        
        // 展开/折叠响应详情
        document.querySelector('.accordion').addEventListener('click', function() {
            const content = this.nextElementSibling;
            content.style.display = content.style.display === 'block' ? 'none' : 'block';
        });
        
        // 图像生成功能
        generateBtn.addEventListener('click', async function() {
            const prompt = generatePrompt.value.trim();
            const apiKey = apiKeyInput.value.trim();
            const apiUrl = apiUrlInput.value.trim();
            
            if (!prompt) {
                showError(generateError, "请输入图像描述");
                return;
            }
            
            if (!apiKey) {
                showError(generateError, "请输入API密钥");
                return;
            }
            
            // 清除之前的结果
            generateStatus.textContent = "生成中...";
            generateError.style.display = 'none';
            generatedImage.style.display = 'none';
            generateTextResult.textContent = '';
            generateBtn.disabled = true;
            generateBtn.innerHTML = '生成中 <span class="loading"></span>';
            
            try {
                const result = await callGeminiAPI(
                    `${apiUrl}/v1beta/models/gemini-2.0-flash-exp-image-generation:generateContent`,
                    apiKey,
                    prompt
                );
                
                // 保存完整响应
                fullResponse.textContent = JSON.stringify(result, null, 2);
                
                // 处理结果
                processApiResult(result, generateTextResult, generatedImage);
                
                generateStatus.textContent = "图像生成成功！";
            } catch (error) {
                showError(generateError, `生成失败: ${error.message}`);
                generateStatus.textContent = "生成失败";
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = '生成图像';
            }
        });
        
        // 图像上传功能
        dropzone.addEventListener('click', () => fileInput.click());
        
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('active');
        });
        
        dropzone.addEventListener('dragleave', () => {
            dropzone.classList.remove('active');
        });
        
        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('active');
            
            if (e.dataTransfer.files.length) {
                handleFile(e.dataTransfer.files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleFile(e.target.files[0]);
            }
        });
        
        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showError(editError, "请上传图片文件");
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                uploadedImage.src = e.target.result;
                uploadedImage.style.display = 'block';
                
                // 提取base64数据
                uploadedImageData = e.target.result.split(',')[1];
                
                // 启用编辑按钮
                editBtn.disabled = false;
                
                // 隐藏错误信息
                editError.style.display = 'none';
            };
            
            reader.readAsDataURL(file);
        }
        
        // 图像编辑功能
        editBtn.addEventListener('click', async function() {
            const prompt = editPrompt.value.trim();
            const apiKey = apiKeyInput.value.trim();
            const apiUrl = apiUrlInput.value.trim();
            
            if (!prompt) {
                showError(editError, "请输入编辑指令");
                return;
            }
            
            if (!apiKey) {
                showError(editError, "请输入API密钥");
                return;
            }
            
            if (!uploadedImageData) {
                showError(editError, "请先上传图片");
                return;
            }
            
            // 清除之前的结果
            editStatus.textContent = "编辑中...";
            editError.style.display = 'none';
            editedImage.style.display = 'none';
            editTextResult.textContent = '';
            editBtn.disabled = true;
            editBtn.innerHTML = '编辑中 <span class="loading"></span>';
            
            try {
                const result = await callGeminiAPIWithImage(
                    `${apiUrl}/v1beta/models/gemini-2.0-flash-exp-image-generation:generateContent`,
                    apiKey,
                    prompt,
                    uploadedImageData,
                    getMimeType(uploadedImage.src)
                );
                
                // 保存完整响应
                fullResponse.textContent = JSON.stringify(result, null, 2);
                
                // 处理结果
                processApiResult(result, editTextResult, editedImage);
                
                editStatus.textContent = "图像编辑成功！";
            } catch (error) {
                showError(editError, `编辑失败: ${error.message}`);
                editStatus.textContent = "编辑失败";
            } finally {
                editBtn.disabled = false;
                editBtn.textContent = '编辑图像';
            }
        });
        
        // 辅助函数
        async function callGeminiAPI(url, apiKey, prompt) {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-goog-api-key': apiKey
                },
                body: JSON.stringify({
                    contents: [
                        {
                            role: 'user',
                            parts: [
                                {
                                    text: prompt
                                }
                            ]
                        }
                    ],
                    responseModalities: ["Text", "Image"]
                })
            });
            
            if (!response.ok) {
                throw new Error(`API错误: ${response.status} ${response.statusText}`);
            }
            
            return await response.json();
        }
        
        async function callGeminiAPIWithImage(url, apiKey, prompt, imageData, mimeType) {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-goog-api-key': apiKey
                },
                body: JSON.stringify({
                    contents: [
                        {
                            role: 'user',
                            parts: [
                                {
                                    text: prompt
                                },
                                {
                                    inlineData: {
                                        mimeType: mimeType,
                                        data: imageData
                                    }
                                }
                            ]
                        }
                    ],
                    responseModalities: ["Text", "Image"]
                })
            });
            
            if (!response.ok) {
                throw new Error(`API错误: ${response.status} ${response.statusText}`);
            }
            
            return await response.json();
        }
        
        function processApiResult(result, textElement, imageElement) {
            if (!result || !result.candidates || !result.candidates[0] || !result.candidates[0].content || !result.candidates[0].content.parts) {
                throw new Error("API返回结果格式错误");
            }
            
            const parts = result.candidates[0].content.parts;
            
            for (const part of parts) {
                if (part.text) {
                    textElement.textContent = part.text;
                } else if (part.inlineData && part.inlineData.data) {
                    imageElement.src = `data:${part.inlineData.mimeType || 'image/png'};base64,${part.inlineData.data}`;
                    imageElement.style.display = 'block';
                }
            }
        }
        
        function showError(element, message) {
            element.textContent = message;
            element.style.display = 'block';
        }
        
        function getMimeType(dataUrl) {
            const match = dataUrl.match(/^data:([^;]+);/);
            return match ? match[1] : 'image/png';
        }
        
        // 加载本地存储的API密钥
        window.addEventListener('load', function() {
            const savedApiKey = localStorage.getItem('geminiApiKey');
            if (savedApiKey) {
                apiKeyInput.value = savedApiKey;
            }
        });
        
        // 保存API密钥到本地存储
        apiKeyInput.addEventListener('change', function() {
            localStorage.setItem('geminiApiKey', apiKeyInput.value);
        });
    </script>
</body>
</html> 